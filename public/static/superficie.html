<html>
   <head>
      <script type = "text/javascript" src = "https://d3js.org/d3.v4.min.js"></script>
      <style>
        svg text{
            text-anchor: middle;
            dominant-baseline: middle;
        }
        .superficie_interieure_contour rect{
            stroke-width: 5;
            stroke:rgb(0,0,0);
        }

        .highlight tspan {
            /*
            stroke: #000; stroke-width: 1; stroke-opacity: 0.5;
            */
            font-weight: bold;
        }

      </style>
    </head>
  <body>
    <div>
        <svg id="graph_superficie" width=500 height=500>
        </svg>
    </div>
    <script>
        var superficie_totale = 2000;
        var superficie_exterieure = 500;
        var superficie_bureaux = 700;
        var superficie_ateliers = 400;

        var superficie_interieure = superficie_totale - superficie_exterieure;
        var superficie_autres = superficie_interieure - superficie_bureaux - superficie_ateliers;
        var pc_interieur = superficie_interieure / superficie_totale;
        var pc_bureaux = superficie_bureaux / superficie_interieure;
        var pc_ateliers = superficie_ateliers / superficie_interieure;
        var pc_autres = superficie_autres / superficie_interieure;
        var width = 500;
        var height = 500;
        var names = [
            'superficie_exterieur',
            'superficie_interieure_fond',
            'superficie_interieure_contour',
            'superficie_autres',
            'superficie_bureaux',
            'superficie_ateliers'
        ]

        var function_width = function(d) {
            if (d == 'superficie_exterieur') return width - 20;
            if (d == 'superficie_interieure') return Math.sqrt(pc_interieur) * function_width('superficie_exterieur');
            if (d == 'superficie_interieure_fond') return function_width('superficie_interieure') + 25;
            if (d == 'superficie_interieure_contour') return function_width('superficie_interieure') + 25;
            if (d == 'superficie_autres') return function_width('superficie_interieure') * pc_autres;
            if (d == 'superficie_bureaux') return function_width('superficie_interieure') - function_width('superficie_autres');
            if (d == 'superficie_ateliers') return function_width('superficie_bureaux');
        }

        var function_height = function(d) {
            if (d == 'superficie_exterieur') return height - 20;
            if (d == 'superficie_interieure') return Math.sqrt(pc_interieur) * function_height('superficie_exterieur');
            if (d == 'superficie_interieure_fond') return function_height('superficie_interieure') + 25;
            if (d == 'superficie_interieure_contour') return function_height('superficie_interieure') + 25;
            if (d == 'superficie_autres') return function_height('superficie_interieure') + 5;
            if (d == 'superficie_bureaux') return function_width('superficie_interieure') * function_height('superficie_interieure') * pc_bureaux / function_width('superficie_bureaux');
            if (d == 'superficie_ateliers') return function_height('superficie_autres') - function_height('superficie_bureaux') - 5;
        }

        colors = ['#ffc400', '#ff5728', '#c90035'];

        var function_fill = function(d) {
            if (d == 'superficie_exterieur') return d3.rgb('green');
            if (d == 'superficie_ateliers') return d3.rgb(colors[0]);
            if (d == 'superficie_bureaux') return d3.rgb(colors[1]);
            if (d == 'superficie_autres') return d3.rgb(colors[2]);
            return d3.rgb('white');
        }

        var function_x = function(d) {
            if (d == 'superficie_exterieur') return 0;
            if (d == 'superficie_interieure_fond') return function_x('superficie_interieure') - 20;
            if (d == 'superficie_interieure_contour') return function_x('superficie_interieure') - 10;
            if (d == 'superficie_interieure') return (function_width('superficie_exterieur') - Math.sqrt(pc_interieur) * function_width('superficie_exterieur') ) ;
            if (d == 'superficie_bureaux') return function_x('superficie_interieure');
            if (d == 'superficie_autres') return function_x('superficie_bureaux') + function_width('superficie_bureaux') + 5;
            if (d == 'superficie_ateliers') return function_x('superficie_bureaux');

        }

        var function_y = function(d) {
            if (d == 'superficie_exterieur') return 0;
            if (d == 'superficie_interieure_fond') return function_y('superficie_interieure') - 20;
            if (d == 'superficie_interieure_contour') return function_y('superficie_interieure') - 10;
            if (d == 'superficie_interieure') return (function_height('superficie_exterieur') - Math.sqrt(pc_interieur) * function_height('superficie_exterieur')) ;
            if (d == 'superficie_autres') return function_y('superficie_interieure');
            if (d == 'superficie_bureaux') return function_y('superficie_interieure');
            if (d == 'superficie_ateliers') return function_y('superficie_interieure') + function_height('superficie_bureaux') + 5;
        }

        var function_text_1 = function(d) {
            if (! function_width(d)) {
                return ;
            }
            if (d == 'superficie_exterieur') return 'Extérieurs: '+parseInt(superficie_exterieure) + ' m²';;
            if (function_height(d) < 100) {
                if (d == 'superficie_autres') return 'Autres: '+ parseInt(superficie_autres) + ' m²';
                if (d == 'superficie_bureaux') return 'Bureaux: '+ parseInt(superficie_bureaux) + ' m²';
                if (d == 'superficie_ateliers') return 'Ateliers: '+ parseInt(superficie_ateliers) + ' m²';
            }else {
                if (d == 'superficie_autres') return 'Autres:';
                if (d == 'superficie_bureaux') return 'Bureaux:';
                if (d == 'superficie_ateliers') return 'Ateliers:';
            }
            return ;
        }

        var function_text_2 = function(d) {
            if (! function_width(d)) {
                return ;
            }
            if (function_height(d) >= 100) {
                if (d == 'superficie_autres') return parseInt(superficie_autres) + ' m²';
                if (d == 'superficie_bureaux') return parseInt(superficie_bureaux) + ' m²';
                if (d == 'superficie_ateliers') return parseInt(superficie_ateliers) + ' m²';
            }
        }

        var function_text_x = function(d) {
            return function_x(d) + function_width(d) / 2;
        }

        var function_text_y = function(d) {
            if (d == 'superficie_exterieur') {
                return ((function_height('superficie_exterieur') - function_height('superficie_interieure') ) / 2 );
            }
            return function_y(d) + function_height(d) / 2 ;
        }


        var rect_onmouseover = function(d, i) {
            d3.select(this)
                .attr('fill', function(d) { return function_fill(d).brighter();} );

            d3.select('.'+d+' text')
                .attr('class', 'highlight');
        }

        var rect_onmouseout = function(d, i) {
            console.log('out  '+d+' : '+function_fill(d));
            d3.select(this)
                .attr('fill', function_fill);

            d3.select('.'+d+' text')
                .attr('class', '');
        }

        var parties = d3.select("#graph_superficie")
            .selectAll('g')
            .data(names)
            .attr('class', function(d) {return d})
            .attr('x', function_x )
            .attr('y', function_y )
            .enter()
            .append('g')
            .attr('class', function(d) {return d})
            .attr('x', function_x )
            .attr('y', function_y )

        var rects = parties.append('rect')
            .attr('fill', function_fill )
            .attr('width', function_width )
            .attr('height', function_height )
            .attr('x', function_x )
            .attr('y', function_y )
            .on("mouseover", rect_onmouseover)
            .on("mouseout", rect_onmouseout)

        var texts = parties.append('text')
            .attr('x', function_text_x )
            .attr('y', function_text_y )

        texts.append('tspan')
            .text( function_text_1 )

        texts.append('tspan')
            .text( function_text_2 )
            .attr('x', function_text_x )
            .attr('y', function_text_y )
            .attr('dy', '17' )

    </script>
  </body>
</html>
